<?php
$user->requireLogin();


////////////////////////////////////////////////////////////////////////////////
//TRANSACTIONS!!
////////////////////////////////////////////////////////////////////////////////
$db->begin();




////////////////////////////////////////////////////////////////////////////////
//PULL THE DATA N STUFFZ
////////////////////////////////////////////////////////////////////////////////
\af\affirm(404,
	$gallery = $db->rowId('pudl_gallery', 'gallery_id', $get->id()),
	'Invalid Gallery'
);

\af\affirm(401, $user->is($gallery)  ||  $user->isStaff());




////////////////////////////////////////////////////////////////////////////////
//PULL LIST OF TAGS FROM CLIENT AND CLEAN THEM
////////////////////////////////////////////////////////////////////////////////
$text	= explode(',', $get->text);
foreach ($text as $key => &$item) {
	$item = trim($item);
	if ($item === '') unset($text[$key]);
} unset($item);
$text = array_flip($text);




////////////////////////////////////////////////////////////////////////////////
//PULL EXISTING LIST OF TAGS FROM DATABASE
////////////////////////////////////////////////////////////////////////////////
$tags = $db->rows([
	'gx' => 'pudl_gallery_label',
	'gr' => 'pudl_group',
	'gl' => 'pudl_group_label',
	'gt' => 'pudl_group_type'
], [
	'gl.group_id=gr.group_id',
	'gr.group_type_id=gt.group_type_id',
	'gx.group_label_id=gl.group_label_id',
	'gx.gallery_id'			=> $gallery['gallery_id'],
	'gt.group_type_name'	=> $tagtype,
]);




////////////////////////////////////////////////////////////////////////////////
//REMOVE DUPES BETWEEN LISTS
////////////////////////////////////////////////////////////////////////////////
$olds = [];
foreach ($tags as $item) {
	if (isset($text[ $item['group_label'] ])) {
		unset($text[ $item['group_label'] ]);
	} else {
		$olds[] = $item;
	}
}




////////////////////////////////////////////////////////////////////////////////
//PROCESS EACH ITEM
////////////////////////////////////////////////////////////////////////////////
$x = 0;

foreach ($text as $item => $value) {
	//CAP AT 20 TAGS
	if (++$x > 20) break;

	//GET EXISTING TAG, OR INSERT A NEW ONE IF IT DOESNT EXIST
	$tag = cpnTag::insertLabel($item, $tagtype);

	//TODO: SWITCH THIS OVER TO UNIVERSAL OBJECT LABEL SYSTEM
	$db->upsert('pudl_gallery_label', [
		'gallery_id'				=> $gallery['gallery_id'],
		'group_label_id'			=> $tag,
		'user_id'					=> $user->id(),
		'gallery_label_timestamp'	=> $db->time(),
	]);
}




////////////////////////////////////////////////////////////////////////////////
//REMOVE OLD TAGS
////////////////////////////////////////////////////////////////////////////////
foreach ($olds as $item) {
	$db->delete('pudl_gallery_label', [
		'gallery_id'				=> $gallery['gallery_id'],
		'group_label_id'			=> $item['group_label_id'],
	]);
}




////////////////////////////////////////////////////////////////////////////////
//TRANSACTIONS!!
////////////////////////////////////////////////////////////////////////////////
$db->commit();




////////////////////////////////////////////////////////////////////////////////
//SEND 'OK' SIGNAL BACK TO CLIENT!
////////////////////////////////////////////////////////////////////////////////
$af->ok();
