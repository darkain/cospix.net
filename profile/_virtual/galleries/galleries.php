<?php


if (empty($profile)) {
	require_once('../profile.php.inc');
}




////////////////////////////////////////////////////////////////////////////////
//HIDE EMPTY GALLERIES IF PROFILE IS NOT CURRENT USER
////////////////////////////////////////////////////////////////////////////////
$clause = [];
if (!$profile->is($user)) {
	$clause['thumb_hash'] = pudl::neq(NULL);
}




////////////////////////////////////////////////////////////////////////////////
//LOAD ALL THE CONTENTS!!
////////////////////////////////////////////////////////////////////////////////
$galleries = cpn_gallery::collect($db, [
	'order'		=> 'gallery_sort',
	'clause'	=> $clause + [
		'ga.user_id'	=> $profile->user_id,
	],
]);




////////////////////////////////////////////////////////////////////////////////
//EMPTY RESULT SET
////////////////////////////////////////////////////////////////////////////////
if (!$galleries->count()) {
	$galleries[] = new cpn_custom($db, 'galleries/empty.tpl');
}




////////////////////////////////////////////////////////////////////////////////
//ADD SEARCHING SUPPORT
////////////////////////////////////////////////////////////////////////////////
$galleries->unshift(new cpn_custom($db, 'galleries/search.tpl'));
$galleries->id = 'prometheus-filter-result';
$galleries->data('sort', $afurl->base.'/gallery/sortall');




////////////////////////////////////////////////////////////////////////////////
//ADD SORTING AND GALLERY CREATION LINK
//TODO: WE'RE DOUBLE-ADDING WINDOW HOOKS WITH THIS. THIS IS BAD.
////////////////////////////////////////////////////////////////////////////////
if ($profile->is($user)) {
	$galleries->unshift(new cpn_custom($db, 'galleries/add.tpl'));
	$galleries->unshift(new cpn_custom($db, 'gallery/sort.tpl'));
}




////////////////////////////////////////////////////////////////////////////////
//RENDER ALL THE THINGS!!
////////////////////////////////////////////////////////////////////////////////
if ($get->jq) $galleries->render($af);
