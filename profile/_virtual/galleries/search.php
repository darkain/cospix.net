<?php


if (empty($profile)) {
	require_once('../profile.php.inc');
}




////////////////////////////////////////////////////////////////////////////////
//INITIALIZE SOME DATA
////////////////////////////////////////////////////////////////////////////////
$parts	= preg_split('/\s\s*/', $get->search, -1, PREG_SPLIT_NO_EMPTY);
$itype	= $af->type('image');




////////////////////////////////////////////////////////////////////////////////
//QUICK EASY OUT FOR EMPTY SEARCH QUERY
////////////////////////////////////////////////////////////////////////////////
if (empty($parts)) {
	require('galleries/galleries.php');
	return;
}




////////////////////////////////////////////////////////////////////////////////
//BUILD SEARCH CLAUSE
////////////////////////////////////////////////////////////////////////////////
$clause1 = ['ga.user_id' => $profile->id()];
$clause2 = ['ga.user_id' => $profile->id()];

foreach ($parts as $part) {
	$clause1[] = [
		'ga.gallery_name'	=> pudl::like($part),
		'gl.group_label'	=> pudl::like($part),
		'ev.event_name'		=> pudl::like($part),
		'ev.event_venue'	=> pudl::like($part),
	];

	$clause2[] = [
		'ga.gallery_name'	=> pudl::like($part),
		'gl.group_label'	=> pudl::like($part),
		'ev.event_name'		=> pudl::like($part),
		'ev.event_venue'	=> pudl::like($part),
	];
}




////////////////////////////////////////////////////////////////////////////////
//HIDE EMPTY GALLERIES IF PROFILE IS NOT CURRENT USER
////////////////////////////////////////////////////////////////////////////////
if (!$profile->is($user)) {
	$clause1['thumb_hash'] = pudl::neq(NULL);
	$clause2['thumb_hash'] = pudl::neq(NULL);
}




////////////////////////////////////////////////////////////////////////////////
//START UNION
////////////////////////////////////////////////////////////////////////////////
$db->unionStart();




////////////////////////////////////////////////////////////////////////////////
//SEARCH GALLERY NAME AND TAGS
////////////////////////////////////////////////////////////////////////////////
$rows = $db->group(
	[
		'ga.*',
		'tx.*',
		'th.thumb_hash',
	], [
		'ga' => _pudl_gallery(500) + [
			['left' => ['gx' => 'pudl_gallery_label'],	'using'=>'gallery_id'],
			['left' => ['gz' => 'pudl_group_label'],	'using'=>'group_label_id'],
			['left' => ['gl' => 'pudl_group_label'],	'on'=>'gz.group_id=gl.group_id'],
			['left' => ['ev' => 'pudl_event'],			'on'=>'ga.event_id=ev.event_id'],
		]
	],
	$clause1,
	'ga.gallery_id'
);




////////////////////////////////////////////////////////////////////////////////
//SEARCH IMAGE TAGS
////////////////////////////////////////////////////////////////////////////////
$rows = $db->group(
	[
		'ga.*',
		'tx.*',
		'th.thumb_hash',
	], [
		'ga' => _pudl_gallery(500) + [
			['left' => ['gi' => 'pudl_gallery_image'],	'using'=>'gallery_id'],
			['left' => ['ol' => 'pudl_object_label'],	'on'=>[
				'gi.file_hash=ol.file_hash',
				'ol.object_type_id' => $itype,
			]],
			['left' => ['gz' => 'pudl_group_label'],	'using'=>'group_label_id'],
			['left' => ['gl' => 'pudl_group_label'],	'on'=>'gz.group_id=gl.group_id'],
			['left' => ['ev' => 'pudl_event'],			'on'=>'ga.event_id=ev.event_id'],
		]
	],
	$clause2,
	'ga.gallery_id'
);




////////////////////////////////////////////////////////////////////////////////
//TODO: SEARCH SHARED IMAGES - TAGS
//MY GALLERY > SHARED IMAGE > OTHER'S GALLERY > LABEL > GROUP > LABEL NAMES
////////////////////////////////////////////////////////////////////////////////




////////////////////////////////////////////////////////////////////////////////
//PROCESS QUERY
////////////////////////////////////////////////////////////////////////////////
$galleries = cpn_gallery::manage($db,
	$db->unionGroup(
		'gallery_id',
		'gallery_sort'
	)
);




////////////////////////////////////////////////////////////////////////////////
//NO RESULTS FOUND
////////////////////////////////////////////////////////////////////////////////
if (!$galleries->count()) {
	$galleries[] = new cpn_custom($db, 'galleries/empty.tpl');
}




////////////////////////////////////////////////////////////////////////////////
//ADD PROFILE DATA
////////////////////////////////////////////////////////////////////////////////
$galleries->_extend($profile, [
	'user_id',
	'user_name',
	'user_url',
]);




////////////////////////////////////////////////////////////////////////////////
//ADD SEARCHING SUPPORT
////////////////////////////////////////////////////////////////////////////////
$galleries->unshift(new cpn_custom($db, 'galleries/search.tpl'));
$galleries->id = 'prometheus-filter-result';




////////////////////////////////////////////////////////////////////////////////
//OUTPUT
////////////////////////////////////////////////////////////////////////////////
if ($get->jq) $galleries->render($af);