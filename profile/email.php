<?php

////////////////////////////////////////////////////////////////////////////////
//PULL THE USER PROFILE
////////////////////////////////////////////////////////////////////////////////
$profile = $db->rowId('pudl_user_profile', 'user_id', $get->id());

if (empty($profile)) {
	$profile = $db->rowId('pudl_user_profile', 'user_id', $get->id('i'));
}

\af\affirm(404, $profile);




////////////////////////////////////////////////////////////////////////////////
//PULL THE HASH
////////////////////////////////////////////////////////////////////////////////
\af\affirm(422, $hash = $get->hash());




////////////////////////////////////////////////////////////////////////////////
//VERIFY THE HASH
////////////////////////////////////////////////////////////////////////////////
\af\affirm(401, $hash === md5(
	$af->config->afkey() . $profile['user_id'] . $profile['user_email']
));




////////////////////////////////////////////////////////////////////////////////
//CREATE THE ACCOUNT OBJECT AND REMOVE THE 'VERIFYEMAIL' ATTRIBUTE
////////////////////////////////////////////////////////////////////////////////
$account = new afUser($db, $profile);
$account->profile(['user_attributes' => pudl::removeSet('verifyemail')]);




////////////////////////////////////////////////////////////////////////////////
//RENDER CONFIRMATION PAGE
////////////////////////////////////////////////////////////////////////////////
$af->title = 'Email Verification Complete';
$af->renderPage('email.tpl');
