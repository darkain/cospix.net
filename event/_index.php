<?php


////////////////////////////////////////////////////////////////////////////////
//PAGE TITLE
////////////////////////////////////////////////////////////////////////////////
$af->title = 'Events';




////////////////////////////////////////////////////////////////////////////////
//PROCESS SEARCH QUERY
////////////////////////////////////////////////////////////////////////////////
$clause = [];
if ($get->search) {
	$search = preg_split('/[\s,-]+/', $get->search);
	foreach ($search as $item) {
		$clause[] = [
			'ev.event_name'		=> pudl::regexp(pudl::raw('[[:<:]]'), $item),
			'ev.event_location'	=> pudl::regexp(pudl::raw('[[:<:]]'), $item),
			'ev.event_venue'	=> pudl::regexp(pudl::raw('[[:<:]]'), $item),
		];
	}
}




////////////////////////////////////////////////////////////////////////////////
//PULL LIST OF USERS
////////////////////////////////////////////////////////////////////////////////
$events = cpn_event::collect($db, [
	'clause'	=> $clause + ['thumb_hash' => pudl::neq(NULL)],
	'order'		=> pudl::dsc('ev.event_start'),
	'limit'		=> 100,
]);




////////////////////////////////////////////////////////////////////////////////
//SET THE CONTAINER DIV ID
////////////////////////////////////////////////////////////////////////////////
$events->id = 'prometheus-filter-result';




////////////////////////////////////////////////////////////////////////////////
//RENDER ALL THE THINGS!
////////////////////////////////////////////////////////////////////////////////
$af->header();

if (!$af->jq()) {
	$af->renderField('_cospix/search.tpl', 'search', $get->search);
}

$events->render($af);

$af->footer();
