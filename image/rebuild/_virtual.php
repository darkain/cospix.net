<?php

$user->requireAdmin();




////////////////////////////////////////////////////////////
//SET ONE HOUR TIME LIMIT, AND 1GIB RAM LIMIT
////////////////////////////////////////////////////////////
set_time_limit(AF_HOUR);
ini_set('memory_limit', '1024M');




////////////////////////////////////////////////////////////
//RESET USER SO IMAGE DOESNT TIE TO ADMIN ACCOUNT
////////////////////////////////////////////////////////////
$user = new afAnonymous($db);




////////////////////////////////////////////////////////////
//TRANSACTIONS!!
////////////////////////////////////////////////////////////
$db->begin();




////////////////////////////////////////////////////////////
//PULL IMAGE DATA
////////////////////////////////////////////////////////////
$hash = $router->virtual[0];
$image = $db->row([
	'fl' => 'pudl_file',
	'mt' => 'pudl_mimetype',
], [
	'fl.mime_id=mt.mime_id',
	'file_hash' => pudl::unhex($hash),
]);
\af\affirm(404, $image);




////////////////////////////////////////////////////////////
//DELETE OLD THUMBNAILS
////////////////////////////////////////////////////////////
$thumbs = $db->rowsId('pudl_file_thumb', 'file_hash', pudl::unhex($hash));
foreach ($thumbs as $thumb) {
	@unlink($af->path() . 'files/' . $afurl->cdnPath($thumb['thumb_hash']));
}




////////////////////////////////////////////////////////////
//REMOVE OLD DATA FROM DATABASE
////////////////////////////////////////////////////////////
$db->delete('pudl_file_thumb',	['file_hash'=>pudl::unhex($hash)]);
$db->delete('pudl_file_meta',	['file_hash'=>pudl::unhex($hash)]);




////////////////////////////////////////////////////////////
//REPROCESS IMAGE!
////////////////////////////////////////////////////////////
$url	= $afurl->cdn($image);
if (substr($url, 0, 2) === '//') $url = 'http:' . $url;

$import	= new \af\import($af, $db);
$data	= $import->url($url);




////////////////////////////////////////////////////////////
//UPDATE IMAGE IN DATABASE
////////////////////////////////////////////////////////////
$data['hash'] = bin2hex($image['file_hash']);
$import->database($data);




////////////////////////////////////////////////////////////
//TRANSACTIONS!!
////////////////////////////////////////////////////////////
$db->commit();




////////////////////////////////////////////////////////////
//OUTPUT THE NEW DATA N SHEETZ
////////////////////////////////////////////////////////////
af_dump($data);
