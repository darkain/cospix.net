<?php

$user->requireLogin();

$hash = $get->hash();




////////////////////////////////////////////////////////////
//TRANSACTIONS!!
////////////////////////////////////////////////////////////
$db->begin();




////////////////////////////////////////////////////////////
//LOAD THE IMAGE
////////////////////////////////////////////////////////////
\af\affirm(404,
	$image = $db->row([
		'fu' => 'pudl_file_user',
		'fl' => _pudl_file(100)
	], [
		'fu.file_hash=fl.file_hash',
		'fu.file_hash'	=> pudl::unhex($hash),
		'fu.user_id'	=> $user['user_id'],
	])
);




////////////////////////////////////////////////////////////
//DELETE IMAGE FROM DATABASE
////////////////////////////////////////////////////////////
$db->delete('pudl_gallery_image', [
	'file_hash'		=> pudl::unhex($hash),
	'gallery_id'	=> $db->in()->select(
		'gallery_id',
		'pudl_gallery',
		['user_id' => $user['user_id']]
	)
]);




////////////////////////////////////////////////////////////
//DELETE FROM PEOPLE'S FAVORITES
////////////////////////////////////////////////////////////
$db->delete('pudl_favorite', [
	'file_hash'		=> pudl::unhex($hash),
	'gallery_id'	=> $db->in()->select(
		'gallery_id',
		'pudl_gallery',
		['user_id' => $user['user_id']]
	)
]);




////////////////////////////////////////////////////////////
//REMOVE IMAGE ASSOCIATION FROM USER
////////////////////////////////////////////////////////////
$db->delete('pudl_file_user', [
	'file_hash' => pudl::unhex($hash),
]);




////////////////////////////////////////////////////////////
//UPDATE FAVORITE QUANTITY
////////////////////////////////////////////////////////////
$db->updateCount('pudl_file', 'file_favorites', [
	'file_hash' => pudl::unhex($hash),
], 'pudl_favorite');




////////////////////////////////////////////////////////////
//UPDATE CREDIT QUANTITY
////////////////////////////////////////////////////////////
$db->updateCount('pudl_file', 'file_credits', [
	'file_hash' => pudl::unhex($hash),
], 'pudl_gallery_image');




////////////////////////////////////////////////////////////
//TRANSACTIONS!!
////////////////////////////////////////////////////////////
$db->commit();
