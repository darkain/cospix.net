<?php


////////////////////////////////////////////////////////////////////////////////
//IF WE'RE ALREADY LOGGED IN, JUST REDIRECT PAGE
////////////////////////////////////////////////////////////////////////////////
if ($user->loggedIn()) {
	return require('redirect.php.inc');
}




////////////////////////////////////////////////////////////////////////////////
//PULL THE REQUESTED ACCOUNT
////////////////////////////////////////////////////////////////////////////////
\af\affirm(401,
	$auth = $db->row([
		'ua'=>'pudl_user_auth',
		'us'=>'pudl_user',
	], [
		'auth_account' => $get('auth_account'),
		'us.user_id=ua.user_id',
	]),
	'Invalid Email Address or Password'
);




////////////////////////////////////////////////////////////////////////////////
//VERIFY THE PASSWORD
////////////////////////////////////////////////////////////////////////////////
\af\affirm(401,
	password_verify(
		$get->password('auth_password'),
		$auth['auth_password']
	),
	'Invalid Email Address or Password'
);




////////////////////////////////////////////////////////////////////////////////
//PASS AUTHENTICATION TO ALTAFORM
////////////////////////////////////////////////////////////////////////////////
$af->authenticate($auth);




////////////////////////////////////////////////////////////////////////////////
//REDIRECT THE USER
////////////////////////////////////////////////////////////////////////////////
$user = new afUser($db, $auth);
require('redirect.php.inc');
