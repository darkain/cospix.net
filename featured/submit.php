<?php

$user->requireLogin();




////////////////////////////////////////////////////////////
//TRANSACTIONS!!
////////////////////////////////////////////////////////////
$db->begin();




////////////////////////////////////////////////////////////
//VERIFY WE HAVE THIS IMAGE IN ONE OF OUR GALLERIES
////////////////////////////////////////////////////////////
\af\affirm(404,
	$image = $db->row([
		'gi' => 'pudl_gallery_image',
		'ga' => 'pudl_gallery',
	], [
		'ga.gallery_id=gi.gallery_id',
		'gi.file_hash'	=> $get->hash('id', true),
		'ga.user_id'	=> $user['user_id'],
	])
);




////////////////////////////////////////////////////////////
//ADD THE IMAGE TO THE SUBMISSION POOL
////////////////////////////////////////////////////////////
$id = $db->insertUpdate('pudl_feature_submission', [
	'user_id'				=> $user['user_id'],
	'file_hash'				=> $image['file_hash'],
	'submission_timestamp'	=> $db->time(),
	'vote_total'			=> 0,
], 'submission_id', true);




////////////////////////////////////////////////////////////
//RESET ANY VOTES WE MAY HAVE HAD ALREADY
////////////////////////////////////////////////////////////
$db->delete('pudl_feature_vote', [
	'submission_id'			=> $id,
]);




////////////////////////////////////////////////////////////
//TRANSACTIONS!!!
////////////////////////////////////////////////////////////
$db->commit();




////////////////////////////////////////////////////////////
//OUTPUT STUFFZ
////////////////////////////////////////////////////////////
$af->render('submit.tpl');
